---
title: "Spatial MIBI Report"
format: html
params:
    hierarchy_file: "hierarchy.yaml"
    expression_file: "simulated.csv"
    sample_name: "sample"
---

```{r setup, include=FALSE}
library(devtools)
if (!requireNamespace("spatialVis", quietly = TRUE)) {
    devtools::install_github("WEHI-SODA-HUB/spatialVis")
}
library(spatialVis)
```

```{r, params}
hierarchy_file <- params$hierarchy_file
expression_file <- params$expression_file
sample_name <- params$sample_name

stopifnot(file.exists(hierarchy_file))
stopifnot(file.exists(expression_file))
```

## Spatial MIBI Report

```{r, load-data}
spe <- make_spe_from_expr_data(expression_file, hierarchy_file)
```

```{r, plots}
plot_celltypes(spe)
plot_marker_heatmap(spe)
plot_marker_heatmap(spe, value = "proportion")
plot_umap(spe)
```

```{r, save-data}
outfile <- paste0(sample_name, ".rds")
saveRDS(spe, outfile, compress = "xz")
```
